<p-dialog
  [(visible)]="open"
  [modal]="true"
  [closable]="false"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '34rem' }"
  (onHide)="cerrar.emit()"
>
  <!-- ======= Header ======= -->
  <ng-template pTemplate="header">
    <div class="flex items-center gap-2">
      <i class="pi pi-shopping-cart text-sky-600"></i>
      <span class="font-bold">Vender Medicamento</span>
    </div>
  </ng-template>

  <!-- ======= Contenido ======= -->
  <div class="space-y-4">
    <!-- Producto -->
    <div class="rounded-2xl border p-4 space-y-1">
      <div class="text-lg font-semibold">{{ seleccionado?.nombre }}</div>
      <div class="text-sm text-gray-500">Laboratorio: {{ seleccionado?.laboratorioNombre }}</div>

      <div class="flex items-center justify-between text-sm mt-1">
        <div>Precio unitario:</div>
        <div class="font-semibold">{{ seleccionado?.valorUnitario | number:'1.0-0' }}</div>
      </div>

      <div class="flex items-center justify-between text-sm">
        <div>Stock disponible:</div>
        <div class="font-semibold">
          {{ maxVendible }} <span class="text-gray-500">unidades</span>
        </div>
      </div>
    </div>

    <!-- Cantidad -->
    <form [formGroup]="form" class="space-y-3">
      <label class="text-sm text-gray-600">Cantidad a vender</label>

      <div class="flex items-center gap-2">
        <button
          type="button"
          pButton
          icon="pi pi-minus"
          [text]="true"
          (click)="dec()"
          aria-label="Disminuir cantidad">
        </button>

        <p-inputNumber
          formControlName="cantidad"
          [min]="1"
          [max]="maxVendible" 
          [showButtons]="false"
          inputStyleClass="text-center w-24"
          (onInput)="onCotizar()"
          (onBlur)="onCotizar()"
          ariaLabel="Cantidad a vender">
        </p-inputNumber>

        <button
          type="button"
          pButton
          icon="pi pi-plus"
          [text]="true"
          (click)="inc()"
          aria-label="Aumentar cantidad">
        </button>
      </div>

      <!-- Mensajes -->
      <p-message *ngIf="form.controls.cantidad.hasError('required')" severity="error" text="Ingrese una cantidad."></p-message>
      <p-message *ngIf="form.controls.cantidad.hasError('min')" severity="error" text="La cantidad mínima es 1."></p-message>
      <p-message *ngIf="form.controls.cantidad.hasError('max')" severity="warn" text="No hay stock suficiente."></p-message>
      <p-message *ngIf="maxVendible === 0" severity="error" text="Medicamento agotado."></p-message>

      <!-- Total -->
      <div class="rounded-2xl p-4 text-white" style="background: linear-gradient(90deg, #0056a3, #06b6d4);">
        <div class="text-sm opacity-90">Total a pagar:</div>
        <div class="text-xl font-extrabold mt-1">{{ totalMostrar | number:'1.0-0' }}</div>
        <div class="text-xs opacity-90">
          {{ form.value.cantidad || 1 }} × {{ seleccionado?.valorUnitario | number:'1.0-0' }}
        </div>
      </div>
    </form>
  </div>

  <!-- ======= Footer / Acciones ======= -->
  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <button pButton label="Cancelar" [text]="true" (click)="cerrar.emit()"></button>
      <button
        pButton
        label="Confirmar Venta"
        [loading]="loading"
        [disabled]="loading || maxVendible === 0 || form.invalid"
        (click)="onConfirmar()">
      </button>
    </div>
  </ng-template>
</p-dialog>
