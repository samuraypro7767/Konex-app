<div class="max-w-7xl mx-auto p-4 space-y-6">
  <!-- =========================
    Header local (opcional)
  ========================== -->
  @if (showHeader) {
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-extrabold text-sky-700">Sistema de Gestión KONEX</h1>
        <p class="text-gray-500">Inventario y ventas de medicamentos para droguerías</p>
      </div>
      <button
        (click)="abrirCrear()"
        class="px-4 py-2 rounded-xl bg-sky-600 text-white shadow hover:bg-sky-700"
        aria-label="Agregar medicamento">
        + Agregar Medicamento
      </button>
    </div>
  }

  <!-- =========================
    KPIs
  ========================== -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <app-card-metric label="Medicamentos Almacenados" hint="Total" [value]="totalMedicamentos()">
      <span metric-icon>
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h16v2H4zM4 11h16v2H4zM4 18h16v2H4z"/></svg>
      </span>
    </app-card-metric>

    <app-card-metric label="Stock Total" [value]="stockTotal()" hint="página actual">
      <span metric-icon>
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5a2 2 0 00-2 2v11h2V5h14v11h2V5a2 2 0 01-2-2zM3 19h18v2H3z"/></svg>
      </span>
    </app-card-metric>

    <app-card-metric label="Stock Bajo" [value]="stockBajo()" hint="&lt; 10">
      <span metric-icon>
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
      </span>
    </app-card-metric>

    <app-card-metric label="Ingresos del Mes" [value]="ingresosMes() | currencyCol" hint="mes actual">
      <span metric-icon>
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 1l3 5h-6l3-5zM3 13h18v8H3z"/>
        </svg>
      </span>
    </app-card-metric>
  </div>

  <!-- =========================
    Filtros
  ========================== -->
  <div class="flex items-center gap-2">
    <input
      type="text"
      class="w-72 rounded-xl border px-3 py-2"
      placeholder="Buscar por nombre..."
      [value]="filtroNombre()"
      (input)="onFiltroChange($any($event.target).value)"
      aria-label="Buscar medicamento por nombre"
    />
    <button
      (click)="buscar()"
      class="px-3 py-2 rounded-xl bg-gray-900 text-white"
      aria-label="Ejecutar búsqueda por nombre">
      Buscar
    </button>
  </div>

  <!-- =========================
    Tabla resultados
  ========================== -->
  <div class="rounded-2xl border overflow-hidden">
    <div class="flex justify-end p-2">
      <span class="text-xs rounded-full border px-2 py-1 text-gray-600">
        {{ totalMedicamentos() }} medicamentos
      </span>
    </div>

    <table class="min-w-full">
      <thead class="bg-gray-50">
        <tr class="text-left text-sm text-gray-500">
          <th class="p-3">Medicamento</th>
          <th class="p-3">Laboratorio</th>
          <th class="p-3">Fabricación</th>
          <th class="p-3">Vencimiento</th>
          <th class="p-3">Stock</th>
          <th class="p-3">Precio</th>
          <th class="p-3">Estado</th>
          <th class="p-3">Acciones</th>
        </tr>
      </thead>

      <tbody class="divide-y">
        <tr *ngFor="let m of rows(); trackBy: trackRow" class="text-sm">
          <td class="p-3 font-medium">{{ m.nombre }}</td>
          <td class="p-3">{{ m.laboratorioNombre }}</td>
          <td class="p-3">{{ fmt(m.fechaFabricacion) }}</td>

          <!-- Vencimiento con icono si aplica -->
          <td class="p-3 flex items-center gap-2">
            <svg
              *ngIf="isVencido(m.fechaVencimiento) || isPorVencer(m.fechaVencimiento)"
              xmlns="http://www.w3.org/2000/svg"
              class="w-4 h-4"
              [ngClass]="{
                'text-red-500': isVencido(m.fechaVencimiento),
                'text-amber-500': !isVencido(m.fechaVencimiento)
              }"
              viewBox="0 0 20 20"
              fill="currentColor"
              aria-hidden="true">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.72-1.36 3.485 0l6.518 11.6c.75 1.336-.213 3.001-1.742 3.001H3.48c-1.53 0-2.492-1.665-1.742-3l6.518-11.6zM11 14a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v4a1 1 0 102 0V7a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
            <span
              [class.text-red-600]="isVencido(m.fechaVencimiento)"
              [class.text-amber-600]="!isVencido(m.fechaVencimiento) && isPorVencer(m.fechaVencimiento)">
              {{ fmt(m.fechaVencimiento) }}
            </span>
          </td>

          <td class="p-3">
            <span [class.text-red-600]="m.cantidadStock === 0 || m.cantidadStock < 10">
              {{ m.cantidadStock }}
            </span>
          </td>

          <td class="p-3 font-semibold">
            {{ m.valorUnitario | currencyCol }}
          </td>

          <td class="p-3">
            <app-badge-status
              [status]="m.cantidadStock === 0 ? 'agotado' : (m.cantidadStock < 10 ? 'bajo' : 'ok')">
            </app-badge-status>
          </td>

          <td class="p-3">
            <div class="flex items-center gap-2 text-gray-600">
              <button class="p-2 rounded-lg hover:bg-gray-100" title="Vender" aria-label="Vender" (click)="abrirVender(m)">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round"
                        d="M2.25 3h1.386c.51 0 .955.343 1.084.835l.383 1.437M7.5 14.25h9.75m0 0l1.5-6.75H5.103m2.397 6.75L6.75 6.75m12 11.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"/>
                </svg>
              </button>

              <button class="p-2 rounded-lg hover:bg-gray-100" title="Editar" aria-label="Editar" (click)="abrirEditar(m)">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round"
                        d="M16.862 4.487l1.651 1.651m-9.193 9.193l-3.32.369.37-3.32 9.192-9.193a1.75 1.75 0 112.476 2.476l-9.192 9.193z"/>
                </svg>
              </button>

              <button class="p-2 rounded-lg hover:bg-red-50 text-red-600" title="Eliminar" aria-label="Eliminar" (click)="eliminar(m)">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round"
                        d="M6 7h12m-9 0V5a1 1 0 011-1h2a1 1 0 011 1v2m6 0v12a2 2 0 01-2 2H8a2 2 0 01-2-2V7z"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>

        <tr *ngIf="!loading() && rows().length === 0">
          <td colspan="9" class="p-6 text-center text-gray-500">Sin resultados</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- =========================
    Paginación
  ========================== -->
  <div class="flex items-center justify-between">
    <div class="text-sm text-gray-500">
      Página {{ (data()?.number ?? 0) + 1 }} de {{ data()?.totalPages ?? 1 }}
    </div>
    <div class="flex gap-2">
      <button class="px-3 py-1 rounded-lg border" (click)="paginar(false)" aria-label="Página anterior">
        Anterior
      </button>
      <button class="px-3 py-1 rounded-lg border" (click)="paginar(true)" aria-label="Página siguiente">
        Siguiente
      </button>
    </div>
  </div>

  <!-- =========================
    Modal Crear/Editar
  ========================== -->
  <app-modal
    [open]="showForm()"
    [title]="editando ? 'Editar Medicamento' : 'Nuevo Medicamento'"
    (close)="showForm.set(false)">
    <app-medicamento-form
      [initial]="editando"
      (save)="onGuardar($event)"
      (cancel)="showForm.set(false)">
    </app-medicamento-form>
  </app-modal>

  <!-- =========================
    Dialog Vender
  ========================== -->
  <app-vender-dialog
    [open]="showVender()"
    [seleccionado]="seleccionado"
    [cotizacion]="cotizacion"
    [loading]="vendiendo()"
    (cerrar)="showVender.set(false)"
    (cotizar)="cotizar($event)"
    (confirmar)="confirmarVenta($event)">
  </app-vender-dialog>
</div>
